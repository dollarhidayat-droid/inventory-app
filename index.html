<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Stock HR-GA - Lengkap + Login Overlay</title>

<style>
/* ====================== */
/* GLOBAL STYLING         */
/* ====================== */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f5f6fa;
}

.container {
    padding: 15px;
    max-width: 1000px;
    margin: auto;
}

h2 {
    margin-top: 20px;
    color: #2c3e50;
}

input, select {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
}

button {
    width: 48%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 6px;
    background: #2563eb;
    color: #fff;
    font-size: 15px;
    cursor: pointer;
}

.btn-small {
    width: auto;
    padding: 8px 14px;
}

.row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.card {
    background: white;
    padding: 15px;
    margin-top: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

table th, table td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    font-size: 14px;
    text-align: left;
}

.status-aman {
    color: #085f00;
    font-weight: 600;
}

.status-hampir { 
    color: #b8860b; 
    font-weight: 700; 
}

.status-habis { 
    color: #a40000; 
    font-weight: 600; 
}

.scanner-area {
    display: none;
    margin-top: 10px;
    position: relative;
}

#scanNotif {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #4caf50;
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    display: none;
    font-weight: bold;
}

button.edit-btn, button.remove-btn {
    width: auto;
    padding: 4px 8px;
    font-size: 12px;
    margin-right: 5px;
}

/* LOGIN OVERLAY */
#loginOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

#loginPanel {
    width: 360px;
    background: #fff;
    padding: 22px;
    border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}

#loginPanel h2 {
    margin-top: 0;
    text-align: center;
}

#logoutBtn {
    position: fixed;
    top: 12px;
    right: 12px;
    background: #d32f2f;
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 1000;
    display: none;
}

/* ====================== */
/* END STYLING            */
/* ====================== */
</style>
</head>

<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
    <div id="loginPanel">
        <h2>Login</h2>
        <label>Username</label>
        <input id="loginUser" placeholder="admin / user" />
        <label style="margin-top:8px">Password</label>
        <input id="loginPass" type="password" placeholder="password" />
        <div style="display:flex; gap:8px; margin-top:14px;">
            <button style="flex:1" onclick="doLogin()">Masuk</button>
            <button style="flex:1; background:#6b7280" onclick="fillDemo()">Demo</button>
        </div>
        <p style="margin-top:12px; font-size:13px; color:#555">
            Admin: <b>admin</b> / admin123 — User: <b>user</b> / user123
        </p>
    </div>
</div>

<button id="logoutBtn" onclick="doLogout()">Logout</button>

<div id="appRoot" class="container" style="display:none;">

<h2>Transaksi Stok</h2>
<div class="card">
    <div class="row">
        <button onclick="startScanner()" class="btn-small">Scan (Camera)</button>
        <button class="btn-small" onclick="focusManual()">Manual</button>
    </div>

    <label>Kode Barang</label>
    <input id="kodeBarang" placeholder="Scan/kode" oninput="isiOtomatisDariMaster()" />

    <label>Nama Barang</label>
    <input id="namaBarang" />

    <label>Satuan</label>
    <input id="satuan" />

    <label>Kategori Barang</label>
    <select id="kategoriBarang">
        <option value="">-- Pilih --</option>
        <option>ATK</option>
        <option>LAB</option>
        <option>PROD</option>
        <option>APD</option>
        <option>DAPUR</option>
    </select>

    <label>Line / Departemen</label>
    <select id="lineDept">
        <option value="">-- Pilih --</option>
        <option>Production</option>
        <option>Logistic</option>
        <option>QC/QA</option>
        <option>HR</option>
        <option>Engineering</option>
        <option>Technical</option>
    </select>

    <label>PIC Ambil Barang</label>
    <input id="picAmbil" placeholder="Nama pengambil barang" />

    <label>Sisa Stok (opsional)</label>
    <input id="sisaStok" />

    <label>Qty</label>
    <input id="qty" type="number" value="1" />

    <label>Jenis</label>
    <select id="jenis">
        <option>Masuk</option>
        <option>Keluar</option>
    </select>

    <div class="row">
        <button id="saveTransaksi">Simpan</button>
        <button onclick="exportCSV()">Export CSV</button>
    </div>
</div>

<!-- SCANNER AREA -->
<div class="scanner-area" id="scannerBlock">
    <div id="scanNotif">Barcode Terbaca!</div>
    <video id="preview" style="width:100%; border-radius:10px;"></video>
</div>

<!-- MASTER DATA -->
<h2>Master Data</h2>
<div class="card">
    <label>Barcode</label>
    <input id="mBarcode">

    <label>Nama Barang</label>
    <input id="mNama">

    <label>Satuan</label>
    <input id="mSatuan">

    <label>Minimal Stok</label>
    <input id="mMinimal" type="number" placeholder="Minimal stok">

    <label>Kategori Barang</label>
    <select id="mKategori">
        <option value="">-- Pilih --</option>
        <option>ATK</option>
        <option>LAB</option>
        <option>PROD</option>
        <option>APD</option>
        <option>DAPUR</option>
    </select>

    <label>Line / Dept</label>
    <select id="mLine">
        <option value="">-- Pilih --</option>
        <option>Production</option>
        <option>Logistic</option>
        <option>QC/QA</option>
        <option>HR</option>
        <option>Engineering</option>
        <option>Technical</option>
    </select>

    <label>PIC Input</label>
    <input id="mPic">

    <div class="row">
        <button id="addMaster">Tambah</button>
        <button id="pushMaster" class="btn-small">Push Master → Spreadsheet</button>
    </div>
</div>

<!-- TABEL MASTER DATA -->
<h2>Daftar Master Data</h2>
<div class="card">
    <table id="masterTable">
        <thead>
            <tr>
                <th>Barcode</th>
                <th>Nama</th>
                <th>Satuan</th>
                <th>Minimal</th>
                <th>Kategori</th>
                <th>Line</th>
                <th>PIC</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="masterBody"></tbody>
    </table>
</div>

<!-- RIWAYAT -->
<h2>Riwayat Transaksi</h2>
<div class="card">
    <div class="row">
        <button onclick="downloadRiwayatExcel()">Download Excel</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Waktu</th>
                <th>Kode</th>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Line</th>
                <th>PIC</th>
                <th>Qty</th>
                <th>Jenis</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="riwayatBody"></tbody>
    </table>
</div>

<!-- SISA STOCK -->
<h2>Sisa Stock</h2>
<div class="card">
    <div class="row">
        <button onclick="downloadStockExcel()">Download Excel</button>
    </div>
    <table id="stockTable">
        <thead>
            <tr>
                <th>Kode</th>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Line</th>
                <th>Sisa Stok</th>
                <th>Minimal</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="stockBody"></tbody>
    </table>
</div>

</div>

<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ======================
// SCRIPT UTAMA
// ======================

// CONFIG LOGIN
const API_URL = "https://script.google.com/macros/s/AKfycbx.../exec";
const USERS = { admin:{pass:"admin123",role:"admin"}, user:{pass:"user123",role:"user"} };
let currentRole = localStorage.getItem('role') || null;

function showAppAfterLogin(){
    document.getElementById('loginOverlay').style.display='none';
    document.getElementById('appRoot').style.display='block';
    document.getElementById('logoutBtn').style.display='block';
    applyRoleVisibility();
}

function doLogin(){
    const u=document.getElementById('loginUser').value.trim();
    const p=document.getElementById('loginPass').value.trim();
    if(USERS[u] && USERS[u].pass===p){
        currentRole=USERS[u].role;
        localStorage.setItem('role',currentRole);
        showAppAfterLogin();
        loadMasterFromSheets();
        loadTransaksiFromSheets();
    }else alert('Username/password salah');
}

function fillDemo(){ 
    document.getElementById('loginUser').value='user'; 
    document.getElementById('loginPass').value='user123'; 
}

function doLogout(){
    localStorage.removeItem('role');
    location.reload();
}

function applyRoleVisibility(){
    const role = localStorage.getItem('role');
    document.querySelectorAll('.edit-btn').forEach(b=>b.style.display=(role==='admin')?'inline-block':'none');
    document.querySelectorAll('.remove-btn').forEach(b=>b.style.display=(role==='admin')?'inline-block':'none');
    document.querySelectorAll('.edit-riwayat').forEach(b=>b.style.display=(role==='admin')?'inline-block':'none');
    document.querySelectorAll('.remove-riwayat').forEach(b=>b.style.display=(role==='admin')?'inline-block':'none');
    document.getElementById('pushMaster').style.display = (role==='admin')?'inline-block':'none';
}

if(currentRole) showAppAfterLogin();

// ======================
// KODE SCANNER
// ======================
let scanner;
function startScanner(){
    try{
        scanner=new Instascan.Scanner({video:document.getElementById("preview"),mirror:false});
        scanner.addListener("scan",function(content){
            document.getElementById("kodeBarang").value=content;
            isiOtomatisDariMaster();
            showScanNotif();
            document.querySelector(".scanner-area").style.display="none";
            scanner.stop();
        });
        Instascan.Camera.getCameras().then(cams=>{
            if(cams.length>0){ 
                document.querySelector(".scanner-area").style.display="block"; 
                scanner.start(cams[0]); 
            } else alert("Kamera tidak ditemukan!");
        });
    }catch(e){ alert("Scanner error: "+e); }
}

function focusManual(){ document.getElementById("kodeBarang").focus(); }

function showScanNotif(){
    const n=document.getElementById("scanNotif"); 
    n.style.display="block"; 
    setTimeout(()=>{n.style.display="none";},1200);
}

// ======================
// AUTO-FILL MASTER → TRANSAKSI
// ======================
function isiOtomatisDariMaster(){
    const kode=document.getElementById("kodeBarang").value.trim();
    if(kode===""){ 
        document.getElementById("namaBarang").value=""; 
        document.getElementById("satuan").value=""; 
        return; 
    }
    const master=JSON.parse(localStorage.getItem("masterData"))||[];
    const item=master.find(m=>m.barcode==kode);
    document.getElementById("namaBarang").value=item?item.nama:"";
    document.getElementById("satuan").value=item?item.satuan:"";
}

// ======================
// SIMPAN TRANSAKSI
// ======================
document.getElementById("saveTransaksi").addEventListener("click", async function(){
    const data={
        waktu: new Date().toLocaleString(),
        kode: document.getElementById("kodeBarang").value,
        nama: document.getElementById("namaBarang").value,
        satuan: document.getElementById("satuan").value,
        kategori: document.getElementById("kategoriBarang").value,
        line: document.getElementById("lineDept").value,
        pic: document.getElementById("picAmbil").value,
        qty: Number(document.getElementById("qty").value),
        jenis: document.getElementById("jenis").value
    };
    if(data.kode===""||data.qty===0){ alert("Kode dan Qty wajib diisi!"); return; }

    let transaksi=JSON.parse(localStorage.getItem("transaksi"))||[];
    transaksi.unshift(data);
    localStorage.setItem("transaksi",JSON.stringify(transaksi));

    try{
        await fetch(API_URL,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({action:"simpanTransaksi",...data})
        });
    } catch(err){ console.warn("Gagal kirim ke Sheets:",err); }

    alert("Transaksi tersimpan!");
    clearTransaksiForm();
    tampilkanRiwayat();
    updateStock();
});

function clearTransaksiForm(){
    document.getElementById("kodeBarang").value="";
    document.getElementById("namaBarang").value="";
    document.getElementById("satuan").value="";
    document.getElementById("qty").value=1;
    document.getElementById("kategoriBarang").value="";
    document.getElementById("lineDept").value="";
    document.getElementById("picAmbil").value="";
}

// ======================
// MASTER DATA
// ======================
document.getElementById("addMaster").addEventListener("click",function(){
    let master={
        barcode:document.getElementById("mBarcode").value,
        nama:document.getElementById("mNama").value,
        satuan:document.getElementById("mSatuan").value,
        minimal:Number(document.getElementById("mMinimal").value)||0,
        kategori:document.getElementById("mKategori").value,
        line:document.getElementById("mLine").value,
        pic:document.getElementById("mPic").value
    };

    if(master.barcode===""||master.nama===""){ 
        alert("Barcode & Nama wajib diisi!"); 
        return; 
    }

    let masterData=JSON.parse(localStorage.getItem("masterData"))||[];
    const idx=masterData.findIndex(m=>m.barcode==master.barcode);
    if(idx>=0) masterData[idx]=master; else masterData.push(master);

    localStorage.setItem("masterData",JSON.stringify(masterData));
    alert("Master Data tersimpan lokal!");
    tampilkanMaster();
    updateStock();
});

document.getElementById("pushMaster").addEventListener("click",async function(){
    let master={
        barcode:document.getElementById("mBarcode").value,
        nama:document.getElementById("mNama").value,
        satuan:document.getElementById("mSatuan").value,
        minimal:Number(document.getElementById("mMinimal").value)||0,
        kategori:document.getElementById("mKategori").value,
        line:document.getElementById("mLine").value,
        pic:document.getElementById("mPic").value
    };

    let masterData=JSON.parse(localStorage.getItem("masterData"))||[];
    try{
        await fetch(API_URL,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({action:"pushMaster",data:masterData})
        });
        alert("Master Data dikirim ke Spreadsheet!");
    } catch(e){ alert("Gagal push ke Sheets: "+e); }
});

function tampilkanMaster(){
    const body=document.getElementById("masterBody");
    body.innerHTML="";
    let master=JSON.parse(localStorage.getItem("masterData"))||[];
    master.forEach((m,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
            <td>${m.barcode}</td>
            <td>${m.nama}</td>
            <td>${m.satuan}</td>
            <td>${m.minimal}</td>
            <td>${m.kategori}</td>
            <td>${m.line}</td>
            <td>${m.pic}</td>
            <td>
                <button class="edit-btn btn-small" onclick="editMaster(${i})">Edit</button>
                <button class="remove-btn btn-small" onclick="removeMaster(${i})">Hapus</button>
            </td>`;
        body.appendChild(tr);
    });
    applyRoleVisibility();
}

function editMaster(idx){
    let master=JSON.parse(localStorage.getItem("masterData"))||[];
    const m=master[idx];
    document.getElementById("mBarcode").value=m.barcode;
    document.getElementById("mNama").value=m.nama;
    document.getElementById("mSatuan").value=m.satuan;
    document.getElementById("mMinimal").value=m.minimal;
    document.getElementById("mKategori").value=m.kategori;
    document.getElementById("mLine").value=m.line;
    document.getElementById("mPic").value=m.pic;
}

function removeMaster(idx){
    if(confirm("Hapus data master ini?")){
        let master=JSON.parse(localStorage.getItem("masterData"))||[];
        master.splice(idx,1);
        localStorage.setItem("masterData",JSON.stringify(master));
        tampilkanMaster();
        updateStock();
    }
}

// ======================
// RIWAYAT & STOCK
// ======================
function tampilkanRiwayat(){
    const body=document.getElementById("riwayatBody");
    body.innerHTML="";
    let tr=JSON.parse(localStorage.getItem("transaksi"))||[];
    tr.forEach((t,i)=>{
        const row=document.createElement("tr");
        row.innerHTML=`
            <td>${t.waktu}</td>
            <td>${t.kode}</td>
            <td>${t.nama}</td>
            <td>${t.kategori}</td>
            <td>${t.line}</td>
            <td>${t.pic}</td>
            <td>${t.qty}</td>
            <td>${t.jenis}</td>
            <td>
                <button class="edit-riwayat btn-small" style="display:none">Edit</button>
                <button class="remove-riwayat btn-small" style="display:none" onclick="removeRiwayat(${i})">Hapus</button>
            </td>`;
        body.appendChild(row);
    });
    applyRoleVisibility();
}

function removeRiwayat(idx){
    if(confirm("Hapus riwayat transaksi ini?")){
        let tr=JSON.parse(localStorage.getItem("transaksi"))||[];
        tr.splice(idx,1);
        localStorage.setItem("transaksi",JSON.stringify(tr));
        tampilkanRiwayat();
        updateStock();
    }
}

function updateStock(){
    const stockBody=document.getElementById("stockBody");
    stockBody.innerHTML="";
    let master=JSON.parse(localStorage.getItem("masterData"))||[];
    let tr=JSON.parse(localStorage.getItem("transaksi"))||[];

    master.forEach(m=>{
        let masuk=tr.filter(t=>t.kode===m.barcode && t.jenis==="Masuk").reduce((a,b)=>a+b.qty,0);
        let keluar=tr.filter(t=>t.kode===m.barcode && t.jenis==="Keluar").reduce((a,b)=>a+b.qty,0);
        let sisa=masuk-keluar;
        let statusClass = sisa<=0 ? "status-habis" : sisa<=m.minimal ? "status-hampir" : "status-aman";

        const row=document.createElement("tr");
        row.innerHTML=`
            <td>${m.barcode}</td>
            <td>${m.nama}</td>
            <td>${m.kategori}</td>
            <td>${m.line}</td>
            <td>${sisa}</td>
            <td>${m.minimal}</td>
            <td class="${statusClass}">${statusClass.replace("status-","")}</td>`;
        stockBody.appendChild(row);
    });
}

// ======================
// DOWNLOAD EXCEL
// ======================
function downloadRiwayatExcel(){ downloadTableToExcel("riwayatBody","riwayat_transaksi.xlsx"); }
function downloadStockExcel(){ downloadTableToExcel("stockBody","sisa_stock.xlsx"); }

function downloadTableToExcel(tblBodyId,filename){
    let wb=XLSX.utils.book_new();
    let tb=document.getElementById(tblBodyId).parentElement;
    let ws=XLSX.utils.table_to_sheet(tb);
    XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
    XLSX.writeFile(wb,filename);
}

// ======================
// INIT
// ======================
tampilkanMaster();
tampilkanRiwayat();
updateStock();

</script>
</body>
</html>
