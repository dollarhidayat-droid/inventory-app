<!-- ====================================================================== -->
<!-- ====================== INVENTORY STOCK HR-GA ========================= -->
<!-- ====================== FULL EXTENDED VERSION ========================= -->
<!-- ====================== PART 1 (BARIS 1 - Â±800) ======================== -->
<!-- ====================================================================== -->

<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Stock HR-GA - Lengkap + Login Overlay</title>

<style>

/* ====================================================================== */
/* ============================ GLOBAL STYLE ============================= */
/* ====================================================================== */

body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f5f6fa;
}

.container {
  padding: 15px;
  max-width: 1000px;
  margin: auto;
}

h2 {
  margin-top: 20px;
  color: #2c3e50;
}

input,
select {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

button {
  width: 48%;
  padding: 12px;
  margin-top: 10px;
  border: none;
  border-radius: 6px;
  background: #2563eb;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
}

.btn-small {
  width: auto;
  padding: 8px 14px;
}

.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.card {
  background: white;
  padding: 15px;
  margin-top: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

table th,
table td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
  font-size: 14px;
  text-align: left;
}

.status-aman {
  color: #085f00;
  font-weight: 600;
}

.status-hampir {
  color: #b8860b;
  font-weight: 700;
}

.status-habis {
  color: #a40000;
  font-weight: 600;
}

/* ====================================================================== */
/* ============================ LOGIN OVERLAY ============================ */
/* ====================================================================== */

#loginOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#loginPanel {
  width: 360px;
  background: #fff;
  padding: 22px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}

#loginPanel h2 {
  margin-top: 0;
  text-align: center;
}

#logoutBtn {
  position: fixed;
  top: 12px;
  right: 12px;
  background: #d32f2f;
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  z-index: 1000;
  display: none;
}

/* ====================================================================== */
/* ============================ SCANNER AREA ============================= */
/* ====================================================================== */

.scanner-area {
  display: none;
  margin-top: 10px;
  position: relative;
}

#scanNotif {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: #4caf50;
  color: #fff;
  padding: 6px 12px;
  border-radius: 6px;
  display: none;
  font-weight: bold;
}

/* ====================================================================== */
/* ============================ FILTER STOCK ============================= */
/* ====================================================================== */

.filter-stock {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.filter-stock input,
.filter-stock select {
  flex: 1;
}

.info-box {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.info-box div {
  background: #eef2ff;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: bold;
}

/* ====================================================================== */
/* ============================ END STYLE ================================ */
/* ====================================================================== */

</style>
</head>

<body>

<!-- ====================================================================== -->
<!-- ============================ LOGIN UI ================================ -->
<!-- ====================================================================== -->

<div id="loginOverlay">
  <div id="loginPanel">
    <h2>Login</h2>
    <label>Username</label>
    <input id="loginUser" placeholder="admin / user">

    <label style="margin-top:8px">Password</label>
    <input id="loginPass" type="password">

    <div class="row">
      <button onclick="doLogin()">Masuk</button>
      <button style="background:#6b7280" onclick="fillDemo()">Demo</button>
    </div>

    <p style="margin-top:12px;font-size:13px;color:#555">
      Admin: <b>admin</b> / admin123<br>
      User: <b>user</b> / user123
    </p>
  </div>
</div>

<button id="logoutBtn" onclick="doLogout()">Logout</button>

<div id="appRoot" class="container" style="display:none;">

<!-- ====================================================================== -->
<!-- ============================ TRANSAKSI =============================== -->
<!-- ====================================================================== -->

<h2>Transaksi Stok</h2>

<div class="card">

  <div class="row">
    <button onclick="startScanner()" class="btn-small">Scan (Camera)</button>
    <button class="btn-small" onclick="focusManual()">Manual</button>
  </div>

  <label>Kode Barang</label>
  <input id="kodeBarang" oninput="isiOtomatisDariMaster()">

  <label>Nama Barang</label>
  <input id="namaBarang">

  <label>Satuan</label>
  <input id="satuan">

  <label>Kategori</label>
  <select id="kategoriBarang">
    <option value="">-- Pilih --</option>
    <option>ATK</option>
    <option>LAB</option>
    <option>PROD</option>
    <option>APD</option>
    <option>DAPUR</option>
  </select>

  <label>Line / Dept</label>
  <select id="lineDept">
    <option value="">-- Pilih --</option>
    <option>Production</option>
    <option>Logistic</option>
    <option>QC/QA</option>
    <option>HR</option>
    <option>Engineering</option>
    <option>Technical</option>
  </select>

  <label>PIC Ambil</label>
  <input id="picAmbil">

  <label>Qty</label>
  <input id="qty" type="number" value="1">

  <label>Jenis</label>
  <select id="jenis">
    <option>Masuk</option>
    <option>Keluar</option>
  </select>

  <div class="row">
    <button id="saveTransaksi">Simpan</button>
    <button onclick="exportCSV()">Export CSV</button>
  </div>

</div>

<!-- ====================================================================== -->
<!-- ============================ MASTER DATA ============================== -->
<!-- ====================================================================== -->

<h2>Master Data</h2>

<div class="card">

  <label>Barcode</label>
  <input id="mBarcode">

  <label>Nama Barang</label>
  <input id="mNama">

  <label>Satuan</label>
  <input id="mSatuan">

  <label>Minimal Stok</label>
  <input id="mMinimal" type="number">

  <label>Kategori</label>
  <select id="mKategori">
    <option value="">-- Pilih --</option>
    <option>ATK</option>
    <option>LAB</option>
    <option>PROD</option>
    <option>APD</option>
    <option>DAPUR</option>
  </select>

  <label>Line</label>
  <select id="mLine">
    <option value="">-- Pilih --</option>
    <option>Production</option>
    <option>Logistic</option>
    <option>QC/QA</option>
    <option>HR</option>
    <option>Engineering</option>
    <option>Technical</option>
  </select>

  <label>PIC Input</label>
  <input id="mPic">

  <label>Upload Excel Master</label>
  <input type="file" id="uploadExcel" accept=".xls,.xlsx">

  <div class="row">
    <button id="addMaster">Tambah</button>
    <button id="pushMaster" class="btn-small">Push Master</button>
    <button class="btn-small" onclick="uploadMasterExcel()">Upload Excel</button>
  </div>

</div>

<!-- ====================================================================== -->
<!-- ============================ LANJUT PART 2 ============================ -->
<!-- ====================================================================== -->
<!-- ====================================================================== -->
<!-- ============================ DAFTAR MASTER ============================ -->
<!-- ====================================================================== -->

<h2>Daftar Master Data</h2>

<div class="card">
  <table id="masterTable">
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Nama</th>
        <th>Satuan</th>
        <th>Minimal</th>
        <th>Kategori</th>
        <th>Line</th>
        <th>PIC</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="masterBody"></tbody>
  </table>
</div>

<!-- ====================================================================== -->
<!-- ============================ RIWAYAT TRANSAKSI ======================== -->
<!-- ====================================================================== -->

<h2>Riwayat Transaksi</h2>

<div class="card">
  <div class="row">
    <button onclick="downloadRiwayatExcel()">Download Excel</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Waktu</th>
        <th>Kode</th>
        <th>Nama</th>
        <th>Kategori</th>
        <th>Line</th>
        <th>PIC</th>
        <th>Qty</th>
        <th>Jenis</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="riwayatBody"></tbody>
  </table>
</div>

<!-- ====================================================================== -->
<!-- ============================ SISA STOCK =============================== -->
<!-- ====================================================================== -->

<h2>Sisa Stock</h2>

<div class="card">

  <!-- FILTER LANJUTAN -->
  <div class="info-box">
    <div>Total: <span id="infoTotal">0</span></div>
    <div>Aman: <span id="infoAman">0</span></div>
    <div>Warning: <span id="infoWarning">0</span></div>
    <div>Habis: <span id="infoHabis">0</span></div>
  </div>

  <div class="filter-stock">
    <input id="searchStock" placeholder="Cari kode / nama..." oninput="renderStockAdvanced()">

    <select id="filterKategoriStock" onchange="renderStockAdvanced()">
      <option value="">Semua Kategori</option>
      <option>ATK</option>
      <option>LAB</option>
      <option>PROD</option>
      <option>APD</option>
      <option>DAPUR</option>
    </select>

    <select id="filterLineStock" onchange="renderStockAdvanced()">
      <option value="">Semua Line</option>
      <option>Production</option>
      <option>Logistic</option>
      <option>QC/QA</option>
      <option>HR</option>
      <option>Engineering</option>
      <option>Technical</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Kode</th>
        <th>Nama</th>
        <th>Kategori</th>
        <th>Line</th>
        <th>Sisa</th>
        <th>Minimal</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="stockBody"></tbody>
  </table>

</div>

</div> <!-- END appRoot -->

<!-- ====================================================================== -->
<!-- ============================ SCRIPT AREA ============================== -->
<!-- ====================================================================== -->

<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ====================================================================== */
/* ============================ LOGIN SYSTEM ============================= */
/* ====================================================================== */

const USERS = {
  admin:{pass:"admin123",role:"admin"},
  user:{pass:"user123",role:"user"}
};

let currentRole = localStorage.getItem("role");

function doLogin(){
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  if(USERS[u] && USERS[u].pass === p){
    currentRole = USERS[u].role;
    localStorage.setItem("role", currentRole);
    loginOverlay.style.display="none";
    appRoot.style.display="block";
    logoutBtn.style.display="block";
    loadAll();
  } else {
    alert("Login gagal");
  }
}

function fillDemo(){
  loginUser.value="user";
  loginPass.value="user123";
}

function doLogout(){
  localStorage.clear();
  location.reload();
}

if(currentRole){
  loginOverlay.style.display="none";
  appRoot.style.display="block";
  logoutBtn.style.display="block";
  loadAll();
}

/* ====================================================================== */
/* ============================ SCANNER ================================= */
/* ====================================================================== */

let scanner;
function startScanner(){
  scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
  scanner.addListener('scan', function (content) {
    kodeBarang.value = content;
    isiOtomatisDariMaster();
    scanner.stop();
  });
  Instascan.Camera.getCameras().then(function (cameras) {
    if (cameras.length > 0) {
      scanner.start(cameras[0]);
    } else {
      alert('Camera not found');
    }
  });
}

function focusManual(){
  kodeBarang.focus();
}

/* ====================================================================== */
/* ============================ MASTER DATA =============================== */
/* ====================================================================== */

function isiOtomatisDariMaster(){
  let kode = kodeBarang.value;
  let master = JSON.parse(localStorage.getItem("masterData")) || [];
  let m = master.find(x=>x.barcode===kode);
  namaBarang.value = m ? m.nama : "";
  satuan.value = m ? m.satuan : "";
}

addMaster.onclick = function(){
  let master = {
    barcode: mBarcode.value,
    nama: mNama.value,
    satuan: mSatuan.value,
    minimal: Number(mMinimal.value)||0,
    kategori: mKategori.value,
    line: mLine.value,
    pic: mPic.value
  };
  if(!master.barcode || !master.nama){
    alert("Barcode & Nama wajib");
    return;
  }
  let data = JSON.parse(localStorage.getItem("masterData")) || [];
  let idx = data.findIndex(x=>x.barcode===master.barcode);
  if(idx>=0) data[idx]=master; else data.push(master);
  localStorage.setItem("masterData",JSON.stringify(data));
  tampilkanMaster();
  renderStockAdvanced();
};

function uploadMasterExcel(){
  const file = uploadExcel.files[0];
  if(!file) return alert("Pilih file Excel");
  const reader = new FileReader();
  reader.onload = e=>{
    const wb = XLSX.read(e.target.result,{type:"array"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws,{defval:""});
    let master=[];
    json.forEach(r=>{
      if(!r.Barcode) return;
      master.push({
        barcode:r.Barcode,
        nama:r.Nama||"",
        satuan:r.Satuan||"",
        minimal:Number(r.Minimal)||0,
        kategori:r.Kategori||"",
        line:r.Line||"",
        pic:r.PIC||""
      });
    });
    localStorage.setItem("masterData",JSON.stringify(master));
    tampilkanMaster();
    renderStockAdvanced();
  };
  reader.readAsArrayBuffer(file);
}

function tampilkanMaster(){
  let data = JSON.parse(localStorage.getItem("masterData")) || [];
  masterBody.innerHTML="";
  data.forEach(m=>{
    masterBody.innerHTML+=`
      <tr>
        <td>${m.barcode}</td>
        <td>${m.nama}</td>
        <td>${m.satuan}</td>
        <td>${m.minimal}</td>
        <td>${m.kategori}</td>
        <td>${m.line}</td>
        <td>${m.pic}</td>
        <td>
          <button onclick="editMaster('${m.barcode}')">Edit</button>
          <button onclick="hapusMaster('${m.barcode}')">Hapus</button>
        </td>
      </tr>`;
  });
}

function editMaster(barcode){
  let data = JSON.parse(localStorage.getItem("masterData")) || [];
  let m = data.find(x=>x.barcode===barcode);
  if(!m) return;
  mBarcode.value=m.barcode;
  mNama.value=m.nama;
  mSatuan.value=m.satuan;
  mMinimal.value=m.minimal;
  mKategori.value=m.kategori;
  mLine.value=m.line;
  mPic.value=m.pic;
}

function hapusMaster(barcode){
  if(!confirm("Hapus data?")) return;
  let data = JSON.parse(localStorage.getItem("masterData")) || [];
  data = data.filter(x=>x.barcode!==barcode);
  localStorage.setItem("masterData",JSON.stringify(data));
  tampilkanMaster();
  renderStockAdvanced();
}

/* ====================================================================== */
/* ============================ TRANSAKSI ================================ */
/* ====================================================================== */

saveTransaksi.onclick = function(){
  let trx = {
    waktu: new Date().toLocaleString(),
    kode: kodeBarang.value,
    nama: namaBarang.value,
    kategori: kategoriBarang.value,
    line: lineDept.value,
    pic: picAmbil.value,
    qty: Number(qty.value),
    jenis: jenis.value
  };
  if(!trx.kode || trx.qty<=0) return alert("Kode & Qty wajib");
  let data = JSON.parse(localStorage.getItem("transaksi")) || [];
  data.unshift(trx);
  localStorage.setItem("transaksi",JSON.stringify(data));
  tampilkanRiwayat();
  renderStockAdvanced();
};

function tampilkanRiwayat(){
  let data = JSON.parse(localStorage.getItem("transaksi")) || [];
  riwayatBody.innerHTML="";
  data.forEach((t,i)=>{
    riwayatBody.innerHTML+=`
      <tr>
        <td>${t.waktu}</td>
        <td>${t.kode}</td>
        <td>${t.nama}</td>
        <td>${t.kategori}</td>
        <td>${t.line}</td>
        <td>${t.pic}</td>
        <td>${t.qty}</td>
        <td>${t.jenis}</td>
        <td>
          <button onclick="editRiwayat(${i})">Edit</button>
          <button onclick="hapusRiwayat(${i})">Hapus</button>
        </td>
      </tr>`;
  });
}

function editRiwayat(i){
  let data = JSON.parse(localStorage.getItem("transaksi")) || [];
  let t = data[i];
  if(!t) return;
  kodeBarang.value=t.kode;
  namaBarang.value=t.nama;
  kategoriBarang.value=t.kategori;
  lineDept.value=t.line;
  picAmbil.value=t.pic;
  qty.value=t.qty;
  jenis.value=t.jenis;
  data.splice(i,1);
  localStorage.setItem("transaksi",JSON.stringify(data));
  tampilkanRiwayat();
  renderStockAdvanced();
}

function hapusRiwayat(i){
  if(!confirm("Hapus transaksi?")) return;
  let data = JSON.parse(localStorage.getItem("transaksi")) || [];
  data.splice(i,1);
  localStorage.setItem("transaksi",JSON.stringify(data));
  tampilkanRiwayat();
  renderStockAdvanced();
}

/* ====================================================================== */
/* ============================ STOCK =================================== */
/* ====================================================================== */

function renderStockAdvanced(){
  let transaksi = JSON.parse(localStorage.getItem("transaksi")) || [];
  let master = JSON.parse(localStorage.getItem("masterData")) || [];
  let map = {};

  transaksi.forEach(t=>{
    if(!map[t.kode]){
      let m = master.find(x=>x.barcode===t.kode) || {};
      map[t.kode]={
        kode:t.kode,
        nama:t.nama||m.nama||"",
        kategori:t.kategori||m.kategori||"",
        line:t.line||m.line||"",
        minimal:m.minimal||0,
        sisa:0
      };
    }
    map[t.kode].sisa += t.jenis==="Masuk"?t.qty:-t.qty;
  });

  master.forEach(m=>{
    if(!map[m.barcode]){
      map[m.barcode]={
        kode:m.barcode,
        nama:m.nama,
        kategori:m.kategori||"",
        line:m.line||"",
        minimal:m.minimal||0,
        sisa:0
      };
    }
  });

  let search = searchStock.value.toLowerCase();
  let fk = filterKategoriStock.value;
  let fl = filterLineStock.value;

  let total=0, aman=0, warn=0, habis=0;
  stockBody.innerHTML="";

  Object.values(map).forEach(i=>{
    if(search && !(i.kode+i.nama).toLowerCase().includes(search)) return;
    if(fk && i.kategori!==fk) return;
    if(fl && i.line!==fl) return;

    total++;
    let status="Aman", cls="status-aman";
    if(i.sisa<=0){status="Habis";cls="status-habis";habis++;}
    else if(i.sisa<i.minimal){status="Warning";cls="status-hampir";warn++;}
    else aman++;

    stockBody.innerHTML+=`
      <tr>
        <td>${i.kode}</td>
        <td>${i.nama}</td>
        <td>${i.kategori}</td>
        <td>${i.line}</td>
        <td>${i.sisa}</td>
        <td>${i.minimal}</td>
        <td class="${cls}">${status}</td>
      </tr>`;
  });

  infoTotal.textContent=total;
  infoAman.textContent=aman;
  infoWarning.textContent=warn;
  infoHabis.textContent=habis;
}

/* ====================================================================== */
/* ============================ EXPORT ================================== */
/* ====================================================================== */

function exportCSV(){
  let data = JSON.parse(localStorage.getItem("transaksi")) || [];
  let csv="Waktu,Kode,Nama,Kategori,Line,PIC,Qty,Jenis\n";
  data.forEach(t=>{
    csv+=`${t.waktu},${t.kode},${t.nama},${t.kategori},${t.line},${t.pic},${t.qty},${t.jenis}\n`;
  });
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="transaksi.csv";
  a.click();
}

function downloadRiwayatExcel(){
  let data = JSON.parse(localStorage.getItem("transaksi")) || [];
  let ws_data=[["Waktu","Kode","Nama","Kategori","Line","PIC","Qty","Jenis"]];
  data.forEach(t=>ws_data.push([t.waktu,t.kode,t.nama,t.kategori,t.line,t.pic,t.qty,t.jenis]));
  let wb=XLSX.utils.book_new();
  let ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Riwayat");
  XLSX.writeFile(wb,"Riwayat_Transaksi.xlsx");
}

/* ====================================================================== */
/* ============================ INIT ==================================== */
/* ====================================================================== */

function loadAll(){
  tampilkanMaster();
  tampilkanRiwayat();
  renderStockAdvanced();
}

loadAll();

</script>

</body>
</html>
