<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Stock HR-GA - Lengkap</title>

<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f5f6fa; }
.container { padding: 15px; max-width: 900px; margin: auto; }
h2 { margin-top: 20px; color: #2c3e50; }
input, select { width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ccc; border-radius: 6px; }
button { width: 48%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; background: #2563eb; color: #fff; font-size: 15px; cursor: pointer; }
.btn-small { width: auto; padding: 8px 14px; }
.row { display: flex; gap: 10px; flex-wrap: wrap; }
.card { background: white; padding: 15px; margin-top: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
table th, table td { padding: 8px; border-bottom: 1px solid #ddd; font-size: 14px; text-align: left; }
.scanner-area { display: none; margin-top: 10px; position: relative; }
#scanNotif { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: #4caf50; color: #fff; padding: 6px 12px; border-radius: 6px; display: none; font-weight: bold; }
.status-aman { color: #085f00; font-weight: 600; }
.status-hampir { color: #7a5a00; font-weight: 600; }
.status-habis { color: #a40000; font-weight: 600; }
</style>
</head>

<body>
<div class="container">

<h2>Transaksi Stok</h2>
<div class="card">
    <div class="row">
        <button onclick="startScanner()" class="btn-small">Scan (Camera)</button>
        <button class="btn-small" onclick="focusManual()">Manual</button>
    </div>

    <label>Kode Barang</label>
    <input id="kodeBarang" placeholder="Scan/kode" oninput="isiOtomatisDariMaster()" />

    <label>Nama Barang</label>
    <input id="namaBarang" />

    <label>Satuan</label>
    <input id="satuan" />

    <label>Kategori Barang</label>
    <select id="kategoriBarang">
        <option value="">-- Pilih --</option>
        <option>ATK</option>
        <option>LAB</option>
        <option>PROD</option>
        <option>APD</option>
        <option>DAPUR</option>
    </select>

    <label>Line / Departemen</label>
    <select id="lineDept">
        <option value="">-- Pilih --</option>
        <option>Production</option>
        <option>Logistic</option>
        <option>QC/QA</option>
        <option>HR</option>
        <option>Engineering</option>
        <option>Technical</option>
    </select>

    <label>PIC Ambil Barang</label>
    <input id="picAmbil" placeholder="Nama pengambil barang" />

    <label>Sisa Stok (opsional)</label>
    <input id="sisaStok" />

    <label>Qty</label>
    <input id="qty" type="number" value="1" />

    <label>Jenis</label>
    <select id="jenis">
        <option>Masuk</option>
        <option>Keluar</option>
    </select>

    <div class="row">
        <button id="saveTransaksi">Simpan</button>
        <button onclick="exportCSV()">Export CSV</button>
    </div>
</div>

<!-- SCANNER AREA -->
<div class="scanner-area" id="scannerBlock">
    <div id="scanNotif">Barcode Terbaca!</div>
    <video id="preview" style="width:100%; border-radius:10px;"></video>
</div>

<!-- MASTER DATA -->
<h2>Master Data</h2>
<div class="card">
    <label>Barcode</label>
    <input id="mBarcode">

    <label>Nama Barang</label>
    <input id="mNama">

    <label>Satuan</label>
    <input id="mSatuan">

    <label>Minimal Stok</label>
    <input id="mMinimal" type="number" placeholder="Minimal stok">

    <label>Kategori Barang</label>
    <select id="mKategori">
        <option value="">-- Pilih --</option>
        <option>ATK</option>
        <option>LAB</option>
        <option>PROD</option>
        <option>APD</option>
        <option>DAPUR</option>
    </select>

    <label>Line / Dept</label>
    <select id="mLine">
        <option value="">-- Pilih --</option>
        <option>Production</option>
        <option>Logistic</option>
        <option>QC/QA</option>
        <option>HR</option>
        <option>Engineering</option>
        <option>Technical</option>
    </select>

    <label>PIC Input</label>
    <input id="mPic">

    <div class="row">
        <button id="addMaster">Tambah</button>
        <button id="pushMaster" class="btn-small">Push Master â†’ Spreadsheet</button>
    </div>
</div>

<!-- RIWAYAT -->
<h2>Riwayat Transaksi</h2>
<div class="card">
    <table>
        <thead>
            <tr>
                <th>Waktu</th>
                <th>Kode</th>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Line</th>
                <th>PIC</th>
                <th>Qty</th>
                <th>Jenis</th>
            </tr>
        </thead>
        <tbody id="riwayatBody"></tbody>
    </table>
</div>

<!-- SISA STOCK -->
<h2>Sisa Stock</h2>
<div class="card">
    <table id="stockTable">
        <thead>
            <tr>
                <th>Kode</th>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Line</th>
                <th>Sisa Stok</th>
                <th>Minimal</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="stockBody"></tbody>
    </table>
</div>

</div>

<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script>
// ===== CONFIG =====
const API_URL = "https://script.google.com/macros/s/AKfycbx.../exec"; // Ganti dengan Web App kamu

// ===== SCANNER =====
let scanner;
function startScanner() {
    try {
        scanner = new Instascan.Scanner({ video: document.getElementById("preview"), mirror: false });
        scanner.addListener("scan", function(content) {
            document.getElementById("kodeBarang").value = content;
            // auto-fill nama & satuan setelah scan
            isiOtomatisDariMaster();
            showScanNotif();
            document.querySelector(".scanner-area").style.display = "none";
            scanner.stop();
        });
        Instascan.Camera.getCameras().then(cams => {
            if(cams.length>0){ document.querySelector(".scanner-area").style.display="block"; scanner.start(cams[0]); }
            else alert("Kamera tidak ditemukan!");
        });
    } catch(e){ alert("Scanner error: "+e); }
}

function focusManual(){ document.getElementById("kodeBarang").focus(); }
function showScanNotif(){ const n=document.getElementById("scanNotif"); n.style.display="block"; setTimeout(()=>{n.style.display="none";},1200); }

// ===== AUTO-FILL NAMA + SATUAN dari masterData (localStorage) =====
function isiOtomatisDariMaster() {
    const kode = document.getElementById("kodeBarang").value.trim();
    if (kode === "") {
        document.getElementById("namaBarang").value = "";
        document.getElementById("satuan").value = "";
        return;
    }

    const master = JSON.parse(localStorage.getItem("masterData")) || [];
    const item = master.find(m => m.barcode == kode);

    if (!item) {
        // jika tidak ditemukan biarkan kosong (kategori/line tetap manual)
        document.getElementById("namaBarang").value = "";
        document.getElementById("satuan").value = "";
        return;
    }

    // isi otomatis hanya nama dan satuan
    document.getElementById("namaBarang").value = item.nama || "";
    document.getElementById("satuan").value = item.satuan || "";
}

// ===== TRANSAKSI =====
document.getElementById("saveTransaksi").addEventListener("click", async function(){
    const data = {
        waktu: new Date().toLocaleString(),
        kode: document.getElementById("kodeBarang").value,
        nama: document.getElementById("namaBarang").value,
        satuan: document.getElementById("satuan").value,
        kategori: document.getElementById("kategoriBarang").value,
        line: document.getElementById("lineDept").value,
        pic: document.getElementById("picAmbil").value,
        qty: Number(document.getElementById("qty").value),
        jenis: document.getElementById("jenis").value
    };
    if(data.kode==="" || data.qty===0){ alert("Kode dan Qty wajib diisi!"); return; }
    let transaksi = JSON.parse(localStorage.getItem("transaksi"))||[];
    transaksi.unshift(data); localStorage.setItem("transaksi", JSON.stringify(transaksi));

    // Kirim ke Google Sheets
    try{
        await fetch(API_URL,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action:"simpanTransaksi",...data})});
    } catch(err){ console.warn("Gagal kirim ke Sheets:",err); }

    alert("Transaksi tersimpan!"); clearTransaksiForm(); tampilkanRiwayat(); updateStock();
});

function clearTransaksiForm(){
    document.getElementById("kodeBarang").value="";
    document.getElementById("namaBarang").value="";
    document.getElementById("satuan").value="";
    document.getElementById("qty").value=1;
    document.getElementById("kategoriBarang").value="";
    document.getElementById("lineDept").value="";
    document.getElementById("picAmbil").value="";
}

// ===== MASTER DATA =====
document.getElementById("addMaster").addEventListener("click",function(){
    const master={
        barcode: document.getElementById("mBarcode").value,
        nama: document.getElementById("mNama").value,
        satuan: document.getElementById("mSatuan").value,
        minimal: Number(document.getElementById("mMinimal").value)||0,
        kategori: document.getElementById("mKategori").value,
        line: document.getElementById("mLine").value,
        pic: document.getElementById("mPic").value
    };
    if(master.barcode===""||master.nama===""){ alert("Barcode & Nama wajib diisi!"); return; }
    let masterData=JSON.parse(localStorage.getItem("masterData"))||[];
    const idx = masterData.findIndex(m=>m.barcode==master.barcode);
    if(idx>=0) masterData[idx]=master; else masterData.push(master);
    localStorage.setItem("masterData", JSON.stringify(masterData));
    alert("Master Data tersimpan lokal!");
    loadMasterFromSheets(true);
});

document.getElementById("pushMaster").addEventListener("click",async function(){
    const master={
        barcode: document.getElementById("mBarcode").value,
        nama: document.getElementById("mNama").value,
        satuan: document.getElementById("mSatuan").value,
        minimal: Number(document.getElementById("mMinimal").value)||0,
        kategori: document.getElementById("mKategori").value,
        line: document.getElementById("mLine").value,
        pic: document.getElementById("mPic").value
    };
    let masterData=JSON.parse(localStorage.getItem("masterData"))||[];
    const idx = masterData.findIndex(m=>m.barcode==master.barcode);
    if(idx>=0) masterData[idx]=master; else masterData.push(master);
    localStorage.setItem("masterData", JSON.stringify(masterData));
    try{
        await fetch(API_URL,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action:"simpanMaster",...master})});
        alert("Master data dipush ke spreadsheet (cek console jika gagal).");
    } catch(err){ console.warn("Push Master gagal:",err); alert("Master tersimpan lokal."); }
    loadMasterFromSheets(true);
});

// ===== RIWAYAT & STOCK =====
function tampilkanRiwayat(){
    let transaksi=JSON.parse(localStorage.getItem("transaksi"))||[];
    let tbody=document.getElementById("riwayatBody");
    tbody.innerHTML="";
    transaksi.forEach(t=>{
        tbody.innerHTML+=`<tr>
        <td>${t.waktu}</td><td>${t.kode}</td><td>${t.nama}</td><td>${t.kategori}</td><td>${t.line}</td><td>${t.pic}</td><td>${t.qty}</td><td>${t.jenis}</td>
        </tr>`;
    });
}

async function updateStock(){
    let transaksi=JSON.parse(localStorage.getItem("transaksi"))||[];
    let master=JSON.parse(localStorage.getItem("masterData"))||[];
    let stockMap={};
    transaksi.forEach(t=>{
        if(!stockMap[t.kode]){
            let m=master.find(x=>x.barcode==t.kode)||{};
            stockMap[t.kode]={kode:t.kode,nama:t.nama||m.nama||"",kategori:t.kategori||m.kategori||"",line:t.line||m.line||"",minimal:m.minimal||0,sisa:0};
        }
        if(t.jenis==="Masuk") stockMap[t.kode].sisa+=Number(t.qty);
        else stockMap[t.kode].sisa-=Number(t.qty);
    });
    master.forEach(m=>{if(!stockMap[m.barcode]) stockMap[m.barcode]={kode:m.barcode,nama:m.nama,kategori:m.kategori||"",line:m.line||"",minimal:m.minimal||0,sisa:0};});
    let stockArray=Object.values(stockMap).sort((a,b)=>a.sisa-b.sisa);
    let tbody=document.getElementById("stockBody"); tbody.innerHTML="";
    stockArray.forEach(item=>{
        let statusText="",cls="";
        if(item.sisa<=0){statusText="Habis"; cls="status-habis";}
        else if(item.sisa<item.minimal){statusText="Hampir Habis"; cls="status-hampir";}
        else{statusText="Aman"; cls="status-aman";}
        tbody.innerHTML+=`<tr>
        <td>${item.kode}</td><td>${item.nama}</td><td>${item.kategori}</td><td>${item.line}</td><td>${item.sisa}</td><td>${item.minimal}</td><td class="${cls}">${statusText}</td>
        </tr>`;
    });
}

// ===== EXPORT CSV =====
function exportCSV(){
    let transaksi=JSON.parse(localStorage.getItem("transaksi"))||[];
    if(transaksi.length===0){alert("Belum ada data transaksi."); return;}
    let csv="Waktu,Kode,Nama,Kategori,Line,PIC,Qty,Jenis\n";
    transaksi.forEach(t=>{csv+=`${t.waktu},${t.kode},${t.nama},${t.kategori},${t.line},${t.pic},${t.qty},${t.jenis}\n`;});
    let blob=new Blob([csv],{type:"text/csv"});
    let url=URL.createObjectURL(blob);
    let a=document.createElement("a"); a.href=url; a.download="transaksi.csv"; a.click();
}

// ===== LOAD MASTER DARI SHEETS =====
async function loadMasterFromSheets(ignoreErrors=false){
    try{
        const res=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getMasterData"})});
        const txt=await res.text();
        let data;
        try{data=JSON.parse(txt);}catch(e){data=null;}
        if(Array.isArray(data)){
            const cleaned=data.map(r=>({barcode:r.kode||r.barcode,nama:r.nama||"",satuan:r.satuan||"",minimal:Number(r.min||0),kategori:r.kategori||"",line:r.line||"",pic:r.pic||""}));
            localStorage.setItem("masterData",JSON.stringify(cleaned));
        }
    }catch(err){console.warn("Gagal load master dari Sheets:",err);}
    finally{tampilkanRiwayat(); updateStock();}
}

// ===== INITIAL LOAD =====
tampilkanRiwayat(); loadMasterFromSheets();
</script>
</body>
</html>
