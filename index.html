<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Stock HR-GA - FINAL</title>
<style>
body{font-family:Arial;margin:0;background:#f5f6fa}
.container{max-width:1000px;margin:auto;padding:15px}
h2{color:#2c3e50}
input,select{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:6px}
button{padding:10px 14px;border:none;border-radius:6px;background:#2563eb;color:#fff;cursor:pointer}
.btn-small{padding:6px 10px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.card{background:#fff;padding:15px;border-radius:10px;margin-top:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #ddd;font-size:14px}
.status-aman{color:green;font-weight:bold}
.status-warning{color:#b8860b;font-weight:bold;background:#fff8dc}
.status-habis{color:red;font-weight:bold;background:#ffe4e1}

/* LOGIN */
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:999}
#loginPanel{background:#fff;width:350px;padding:20px;border-radius:10px}
#logoutBtn{position:fixed;top:10px;right:10px;background:#d32f2f;display:none}

/* SCANNER */
.scanner-area{display:none;margin-top:10px}

/* FILTER & SEARCH */
#stockFilterRow, #reportFilterRow{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}

/* DONE MESSAGE */
#doneMsg{font-size:14px;color:green;margin-bottom:5px;font-weight:bold}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginPanel">
    <h2>Login</h2>
    <label>Username</label>
    <input id="loginUser">
    <label>Password</label>
    <input id="loginPass" type="password">
    <div class="row">
      <button onclick="doLogin()">Masuk</button>
      <button onclick="fillDemo()" style="background:#6b7280">Demo</button>
    </div>
    <p style="font-size:13px">
      Admin: admin / admin123<br>
      User: user / user123
    </p>
  </div>
</div>

<button id="logoutBtn" onclick="doLogout()">Logout</button>

<div id="appRoot" class="container" style="display:none">

<!-- DONE MESSAGE -->
<div id="doneMsg"></div>

<!-- ================= TRANSAKSI ================= -->
<h2>Transaksi Stok</h2>
<div class="card">
<div class="row">
  <button class="btn-small" onclick="startScanner()">Scan</button>
  <button class="btn-small" onclick="kodeBarang.focus()">Manual</button>
</div>

<div class="scanner-area" id="scannerArea">
  <video id="preview" style="width:100%;border-radius:8px"></video>
</div>

<label>Kode</label>
<input id="kodeBarang" oninput="isiOtomatis()">
<label>Nama</label>
<input id="namaBarang">
<label>Satuan</label>
<input id="satuan">
<label>Kategori</label>
<input id="kategoriBarang">
<label>Line</label>
<input id="lineDept">
<label>PIC</label>
<input id="picAmbil">
<label>Qty</label>
<input id="qty" type="number" value="1">
<label>Jenis</label>
<select id="jenis">
  <option>Masuk</option>
  <option>Keluar</option>
</select>

<div class="row">
  <button onclick="simpanTransaksi()">Simpan</button>
</div>

<hr>

<label>Upload Excel Transaksi</label>
<input type="file" id="uploadTransaksi" accept=".xls,.xlsx">
<button class="btn-small" onclick="uploadTransaksiExcel()">Upload Excel</button>
</div>

<!-- ================= MASTER ================= -->
<h2>Master Data</h2>
<div class="card admin-only">
<input id="mBarcode" placeholder="Barcode">
<input id="mNama" placeholder="Nama">
<input id="mSatuan" placeholder="Satuan">
<input id="mMinimal" type="number" placeholder="Minimal">
<input id="mKategori" placeholder="Kategori">
<input id="mLine" placeholder="Line">
<input id="mPic" placeholder="PIC">
<input type="file" id="uploadExcel" accept=".xls,.xlsx">
<div class="row">
  <button onclick="tambahMaster()">Tambah</button>
  <button onclick="uploadMasterExcel()" class="btn-small">Upload Excel</button>
</div>
</div>

<!-- ================= TABLE MASTER ================= -->
<div class="card">
<table>
<thead>
<tr>
<th>Barcode</th><th>Nama</th><th>Satuan</th><th>Min</th><th>Kategori</th><th>Line</th><th class="admin-only">Aksi</th>
</tr>
</thead>
<tbody id="masterBody"></tbody>
</table>
</div>

<!-- ================= STOCK ================= -->
<h2>Sisa Stock</h2>
<div class="card">
<div id="stockFilterRow">
  <select id="filterKategori" onchange="renderStock()">
    <option value="">-- Semua Kategori --</option>
  </select>
  <input id="searchStock" placeholder="Cari Nama / Kode" oninput="renderStock()">
</div>
<table>
<thead>
<tr><th>Kode</th><th>Nama</th><th>Sisa</th><th>Min</th><th>Status</th></tr>
</thead>
<tbody id="stockBody"></tbody>
</table>
</div>

<!-- ================= REPORT TRANSAKSI ================= -->
<h2>Report Transaksi</h2>
<div class="card">
<div id="reportFilterRow" class="row">
  <input type="date" id="reportTanggal" onchange="renderReport()">
  <select id="reportJenis" onchange="renderReport()">
    <option value="">-- Semua Jenis --</option>
    <option value="Masuk">Masuk</option>
    <option value="Keluar">Keluar</option>
  </select>
  <input id="searchReport" placeholder="Cari Kode/Nama" oninput="renderReport()">
  <button class="btn-small" onclick="downloadReportExcel()">Download Excel</button>
</div>
<table>
<thead>
<tr><th>Tanggal</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Jenis</th></tr>
</thead>
<tbody id="reportBody"></tbody>
</table>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script>
// ambil elemen DOM
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginOverlay = document.getElementById("loginOverlay");
const appRoot = document.getElementById("appRoot");
const logoutBtn = document.getElementById("logoutBtn");

// USERS
const USERS={admin:{pass:"admin123",role:"admin"},user:{pass:"user123",role:"user"}}
let currentRole=null

/* ================= LOGIN ================= */
function doLogin(){
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  if(USERS[u] && USERS[u].pass === p){
    currentRole = USERS[u].role;
    loginOverlay.style.display = "none";
    appRoot.style.display = "block";
    logoutBtn.style.display = "block";
    applyRole();
    loadAll();
  } else {
    alert("Login gagal: username atau password salah");
  }
}

function fillDemo(){loginUser.value="user"; loginPass.value="user123";}
function doLogout(){location.reload()}

/* ================= ROLE ================= */
function applyRole(){document.querySelectorAll(".admin-only").forEach(el=>el.style.display=currentRole==="admin"?"":"none");}

/* ================= DONE MESSAGE ================= */
function showDoneMessage(msg){
  const div=document.getElementById("doneMsg");
  div.innerText=msg;
  div.style.color="green";
  setTimeout(()=>{div.innerText=""},3000);
}

/* ================= MASTER ================= */
function tambahMaster(){
  let data=JSON.parse(localStorage.masterData||"[]");
  data.push({
    barcode:mBarcode.value,nama:mNama.value,satuan:mSatuan.value,
    minimal:+mMinimal.value||0,kategori:mKategori.value,line:mLine.value,pic:mPic.value
  });
  localStorage.masterData=JSON.stringify(data);
  tampilMaster();
  showDoneMessage("Transaksi Sukses");
}

function uploadMasterExcel(){
  const f=uploadExcel.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:"array"});
    const ws=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    localStorage.masterData=JSON.stringify(ws.map(r=>({
      barcode:r.Barcode,nama:r.Nama,satuan:r.Satuan,
      minimal:+r.Minimal||0,kategori:r.Kategori,line:r.Line,pic:r.PIC
    })));
    localStorage.transaksi="[]";
    localStorage.stockMap="{}";
    tampilMaster();
    renderStock();
    renderReport();
    showDoneMessage("Transaksi Sukses");
  }
  r.readAsArrayBuffer(f);
}

function tampilMaster(){
  const d=JSON.parse(localStorage.masterData||"[]");
  masterBody.innerHTML="";
  d.forEach(m=>{
    masterBody.innerHTML+=`<tr>
      <td>${m.barcode}</td><td>${m.nama}</td><td>${m.satuan}</td>
      <td>${m.minimal}</td><td>${m.kategori}</td><td>${m.line}</td>
      <td class="admin-only"><button onclick="hapusMaster('${m.barcode}')">Hapus</button></td>
    </tr>`;
  });
  applyRole();
  updateKategoriFilter();
}

function hapusMaster(b){
  let d=JSON.parse(localStorage.masterData||"[]");
  localStorage.masterData=JSON.stringify(d.filter(x=>x.barcode!==b));
  tampilMaster();
  showDoneMessage("Transaksi Sukses");
}

/* ================= TRANSAKSI ================= */
function isiOtomatis(){
  const m=JSON.parse(localStorage.masterData||"[]").find(x=>x.barcode===kodeBarang.value);
  if(m){namaBarang.value=m.nama;satuan.value=m.satuan;kategoriBarang.value=m.kategori;lineDept.value=m.line;}
}

function simpanTransaksi(){
  const m=JSON.parse(localStorage.masterData||"[]").find(x=>x.barcode===kodeBarang.value);
  if(!m){alert("Barang tidak ada di master!"); return;}
  let d=JSON.parse(localStorage.transaksi||"[]");
  const tgl=new Date().toISOString().split("T")[0];
  d.unshift({kode:kodeBarang.value,nama:m.nama,qty:+qty.value,jenis:jenis.value,tanggal:tgl});
  localStorage.transaksi=JSON.stringify(d);
  renderStock();
  renderReport();
  showDoneMessage("Transaksi Sukses");
}

function uploadTransaksiExcel(){
  const f=uploadTransaksi.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "array" });
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    const master = JSON.parse(localStorage.masterData || "[]");
    let stockMap = {};
    let d = [];
    rows.forEach(r => {
      const m = master.find(x => x.barcode==r.Barcode);
      if(m){
        const tgl = r.Tanggal ? new Date(r.Tanggal).toISOString().split("T")[0] : new Date().toISOString().split("T")[0];
        const qty = +r.Qty;
        d.push({ kode: m.barcode, nama: m.nama, qty: qty, jenis: r.Jenis, tanggal: tgl });
        stockMap[m.barcode] = stockMap[m.barcode]||0;
        stockMap[m.barcode] += r.Jenis === "Masuk"? qty : -qty;
      }
    });
    localStorage.transaksi = JSON.stringify(d);
    localStorage.stockMap = JSON.stringify(stockMap);
    renderStock();
    renderReport();
    showDoneMessage("Transaksi Sukses");
  }
  r.readAsArrayBuffer(f);
}

/* ================= STOCK ================= */
function renderStock(){
  const master = JSON.parse(localStorage.masterData||"[]");
  const trx = JSON.parse(localStorage.transaksi||"[]");
  const filterKategori = document.getElementById("filterKategori").value.toLowerCase();
  const search = document.getElementById("searchStock").value.toLowerCase();
  let stockMap = JSON.parse(localStorage.stockMap||"{}");
  trx.forEach(t=>{stockMap[t.kode] = stockMap[t.kode]||0; stockMap[t.kode] += t.jenis==="Masuk"?t.qty:-t.qty;});

  const stockArr = master.map(m=>{
    const k = m.barcode;
    if(filterKategori && m.kategori.toLowerCase() !== filterKategori) return null;
    if(search && !(m.nama.toLowerCase().includes(search) || k.toLowerCase().includes(search))) return null;
    const sisa = stockMap[k]||0;
    let statusClass="", statusText="";
    if(sisa<=0){statusClass="status-habis"; statusText="Habis";}
    else if(sisa<=m.minimal){statusClass="status-warning"; statusText="Warning";}
    else{statusClass="status-aman"; statusText="Aman";}
    return {kode:k,nama:m.nama,sisa,minimal:m.minimal,statusClass,statusText};
  }).filter(x=>x!==null);

  stockArr.sort((a,b)=>{
    const order = { "status-habis":0, "status-warning":1, "status-aman":2 };
    return order[a.statusClass]-order[b.statusClass];
  });

  stockBody.innerHTML="";
  stockArr.forEach(s=>{
    stockBody.innerHTML+=`<tr>
      <td>${s.kode}</td><td>${s.nama}</td><td>${s.sisa}</td><td>${s.minimal}</td>
      <td class="${s.statusClass}">${s.statusText}</td>
    </tr>`;
  });
}

function updateKategoriFilter(){
  const master=JSON.parse(localStorage.masterData||"[]");
  const sel=document.getElementById("filterKategori");
  const categories=new Set();
  master.forEach(x=>{if(x.kategori) categories.add(x.kategori.trim());});
  sel.innerHTML='<option value="">-- Semua Kategori --</option>';
  Array.from(categories).sort().forEach(c=>{sel.innerHTML+=`<option value="${c}">${c}</option>`;});
}

/* ================= REPORT ================= */
function renderReport(){
  const trx=JSON.parse(localStorage.transaksi||"[]");
  const tglFilter=document.getElementById("reportTanggal").value;
  const jenisFilter=document.getElementById("reportJenis").value;
  const search=document.getElementById("searchReport").value.toLowerCase();
  const sorted=trx.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
  reportBody.innerHTML="";
  sorted.forEach(t=>{
    if(tglFilter && t.tanggal!==tglFilter) return;
    if(jenisFilter && t.jenis!==jenisFilter) return;
    if(search && !(t.kode.toLowerCase().includes(search) || t.nama.toLowerCase().includes(search))) return;
    reportBody.innerHTML+=`<tr>
      <td>${t.tanggal}</td><td>${t.kode}</td><td>${t.nama}</td><td>${t.qty}</td><td>${t.jenis}</td>
    </tr>`;
  });
}

function downloadReportExcel(){
  const trx=JSON.parse(localStorage.transaksi||"[]");
  if(!trx.length){alert("Tidak ada data untuk di download"); return;}
  const wb=XLSX.utils.book_new();
  const ws_data=trx.map(t=>({Tanggal:t.tanggal,Kode:t.kode,Nama:t.nama,Qty:t.qty,Jenis:t.jenis}));
  const ws=XLSX.utils.json_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Report");
  XLSX.writeFile(wb,"Report_Transaksi.xlsx");
}

/* ================= SCANNER ================= */
let scanner;
function startScanner(){
  const scannerArea=document.getElementById("scannerArea");
  scannerArea.style.display="block";
  if(scanner) return;
  scanner=new Instascan.Scanner({video:document.getElementById('preview')});
  scanner.addListener('scan', function(content){
    kodeBarang.value=content;
    isiOtomatis();
    scanner.stop();
    scannerArea.style.display="none";
  });
  Instascan.Camera.getCameras().then(function(cameras){
    if(cameras.length>0) scanner.start(cameras[0]);
    else alert('Tidak ada kamera ditemukan');
  }).catch(function(e){console.error(e);alert('Gagal mengakses kamera: '+e)});
}

function loadAll(){tampilMaster();renderStock();renderReport();}
</script>
</body>
</html>
