<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Stock HR-GA - Multi-user</title>

<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f5f6fa; }
.container { padding: 15px; max-width: 1000px; margin: auto; }
h2 { margin-top: 20px; color: #2c3e50; }
input, select { width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ccc; border-radius: 6px; }
button { width: 48%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; background: #2563eb; color: #fff; font-size: 15px; cursor: pointer; }
.btn-small { width: auto; padding: 8px 14px; }
.row { display: flex; gap: 10px; flex-wrap: wrap; }
.card { background: white; padding: 15px; margin-top: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
table th, table td { padding: 8px; border-bottom: 1px solid #ddd; font-size: 14px; text-align: left; }
.status-aman { color: #085f00; font-weight: 600; }
.status-hampir { color: #7a5a00; font-weight: 600; }
.status-habis { color: #a40000; font-weight: 600; }
.scanner-area { display: none; margin-top: 10px; position: relative; }
#scanNotif { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: #4caf50; color: #fff; padding: 6px 12px; border-radius: 6px; display: none; font-weight: bold; }
button.edit-btn, button.remove-btn { width: auto; padding: 4px 8px; font-size: 12px; margin-right: 5px; }
</style>
</head>

<body>
<div class="container">

<h2>Transaksi Stok</h2>
<div class="card">
    <div class="row">
        <button onclick="startScanner()" class="btn-small">Scan (Camera)</button>
        <button class="btn-small" onclick="focusManual()">Manual</button>
    </div>

    <label>Kode Barang</label>
    <input id="kodeBarang" placeholder="Scan/kode" oninput="isiOtomatisDariMaster()" />

    <label>Nama Barang</label>
    <input id="namaBarang" />

    <label>Satuan</label>
    <input id="satuan" />

    <label>Kategori Barang</label>
    <select id="kategoriBarang">
        <option value="">-- Pilih --</option>
        <option>ATK</option>
        <option>LAB</option>
        <option>PROD</option>
        <option>APD</option>
        <option>DAPUR</option>
    </select>

    <label>Line / Departemen</label>
    <select id="lineDept">
        <option value="">-- Pilih --</option>
        <option>Production</option>
        <option>Logistic</option>
        <option>QC/QA</option>
        <option>HR</option>
        <option>Engineering</option>
        <option>Technical</option>
    </select>

    <label>PIC Ambil Barang</label>
    <input id="picAmbil" placeholder="Nama pengambil barang" />

    <label>Qty</label>
    <input id="qty" type="number" value="1" />

    <label>Jenis</label>
    <select id="jenis">
        <option>Masuk</option>
        <option>Keluar</option>
    </select>

    <div class="row">
        <button id="saveTransaksi">Simpan</button>
        <button onclick="exportCSV()">Export CSV</button>
    </div>
</div>

<!-- SCANNER AREA -->
<div class="scanner-area" id="scannerBlock">
    <div id="scanNotif">Barcode Terbaca!</div>
    <video id="preview" style="width:100%; border-radius:10px;"></video>
</div>

<!-- MASTER DATA -->
<h2>Master Data</h2>
<div class="card">
    <label>Barcode</label>
    <input id="mBarcode">

    <label>Nama Barang</label>
    <input id="mNama">

    <label>Satuan</label>
    <input id="mSatuan">

    <label>Minimal Stok</label>
    <input id="mMinimal" type="number" placeholder="Minimal stok">

    <label>Kategori Barang</label>
    <select id="mKategori">
        <option value="">-- Pilih --</option>
        <option>ATK</option>
        <option>LAB</option>
        <option>PROD</option>
        <option>APD</option>
        <option>DAPUR</option>
    </select>

    <label>Line / Dept</label>
    <select id="mLine">
        <option value="">-- Pilih --</option>
        <option>Production</option>
        <option>Logistic</option>
        <option>QC/QA</option>
        <option>HR</option>
        <option>Engineering</option>
        <option>Technical</option>
    </select>

    <label>PIC Input</label>
    <input id="mPic">

    <div class="row">
        <button id="addMaster">Tambah</button>
        <button id="pushMaster" class="btn-small">Push Master â†’ Spreadsheet</button>
    </div>
</div>

<!-- TABEL MASTER DATA -->
<h2>Daftar Master Data</h2>
<div class="card">
    <table id="masterTable">
        <thead>
            <tr>
                <th>Barcode</th>
                <th>Nama</th>
                <th>Satuan</th>
                <th>Minimal</th>
                <th>Kategori</th>
                <th>Line</th>
                <th>PIC</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="masterBody"></tbody>
    </table>
</div>

<!-- RIWAYAT -->
<h2>Riwayat Transaksi</h2>
<div class="card">
    <div class="row">
        <button onclick="exportRiwayatExcel()">Export Excel</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Waktu</th>
                <th>Kode</th>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Line</th>
                <th>PIC</th>
                <th>Qty</th>
                <th>Jenis</th>
            </tr>
        </thead>
        <tbody id="riwayatBody"></tbody>
    </table>
</div>

<!-- SISA STOCK -->
<h2>Sisa Stock</h2>
<div class="card">
    <div class="row">
        <button onclick="exportStockExcel()">Export Excel</button>
    </div>
    <table id="stockTable">
        <thead>
            <tr>
                <th>Kode</th>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Line</th>
                <th>Sisa Stok</th>
                <th>Minimal</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="stockBody"></tbody>
    </table>
</div>

</div>

<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ===== CONFIG =====
const API_URL = "https://script.google.com/macros/s/AKfycbz3iOx8XiPxXiyFCeo7Yrq4-hCZ0CkCemChhNtlsQBurvGsfEmLdhxAGoIm7OAnBRuQ/exec";

// ===== SCANNER =====
let scanner;
function startScanner() {
    try {
        scanner = new Instascan.Scanner({ video: document.getElementById("preview"), mirror: false });
        scanner.addListener("scan", function(content) {
            document.getElementById("kodeBarang").value = content;
            isiOtomatisDariMaster();
            showScanNotif();
            document.querySelector(".scanner-area").style.display = "none";
            scanner.stop();
        });
        Instascan.Camera.getCameras().then(cams => {
            if(cams.length>0){ document.querySelector(".scanner-area").style.display="block"; scanner.start(cams[0]); }
            else alert("Kamera tidak ditemukan!");
        });
    } catch(e){ alert("Scanner error: "+e); }
}
function focusManual(){ document.getElementById("kodeBarang").focus(); }
function showScanNotif(){ const n=document.getElementById("scanNotif"); n.style.display="block"; setTimeout(()=>{n.style.display="none";},1200); }

// ===== AUTO-FILL =====
let masterDataGlobal = [];
function isiOtomatisDariMaster() {
    const kode = document.getElementById("kodeBarang").value.trim();
    if (kode === "") { document.getElementById("namaBarang").value=""; document.getElementById("satuan").value=""; return; }
    const item = masterDataGlobal.find(m => m.barcode == kode);
    document.getElementById("namaBarang").value = item ? item.nama : "";
    document.getElementById("satuan").value = item ? item.satuan : "";
}

// ===== TRANSAKSI =====
document.getElementById("saveTransaksi").addEventListener("click", async function(){
    const data = {
        waktu: new Date().toLocaleString(),
        kode: document.getElementById("kodeBarang").value,
        nama: document.getElementById("namaBarang").value,
        satuan: document.getElementById("satuan").value,
        kategori: document.getElementById("kategoriBarang").value,
        line: document.getElementById("lineDept").value,
        pic: document.getElementById("picAmbil").value,
        qty: Number(document.getElementById("qty").value),
        jenis: document.getElementById("jenis").value
    };
    if(data.kode==="" || data.qty===0){ alert("Kode dan Qty wajib diisi!"); return; }

    try{
        await fetch(API_URL,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action:"simpanTransaksi",...data})});
        alert("Transaksi tersimpan!");
    } catch(err){ console.warn("Gagal kirim ke Sheets:",err); alert("Tetap tersimpan di browser, tapi Sheets gagal."); }

    document.getElementById("kodeBarang").value=""; document.getElementById("namaBarang").value="";
    document.getElementById("satuan").value=""; document.getElementById("qty").value=1;
    document.getElementById("kategoriBarang").value=""; document.getElementById("lineDept").value="";
    document.getElementById("picAmbil").value="";
    await loadAllData();
});

// ===== MASTER DATA TABLE =====
function tampilkanMaster(master){
    let tbody=document.getElementById("masterBody");
    tbody.innerHTML="";
    master.forEach((m,i)=>{
        let bg = i%2===0 ? "#f5f5f5" : "#ffffff";
        tbody.innerHTML+=`<tr style="background:${bg}">
            <td>${m.barcode}</td>
            <td>${m.nama}</td>
            <td>${m.satuan}</td>
            <td>${m.minimal}</td>
            <td>${m.kategori}</td>
            <td>${m.line}</td>
            <td>${m.pic}</td>
            <td>
                <button class="edit-btn" onclick="editMaster('${m.barcode}')">Edit</button>
                <button class="remove-btn" onclick="removeMaster('${m.barcode}')">Hapus</button>
            </td>
        </tr>`;
    });
}

// ===== EXPORT EXCEL =====
function exportRiwayatExcel(){
    const rows = [];
    document.querySelectorAll("#riwayatBody tr").forEach(tr=>{
        const cells = tr.querySelectorAll("td");
        rows.push({
            Waktu: cells[0].innerText,
            Kode: cells[1].innerText,
            Nama: cells[2].innerText,
            Kategori: cells[3].innerText,
            Line: cells[4].innerText,
            PIC: cells[5].innerText,
            Qty: cells[6].innerText,
            Jenis: cells[7].innerText
        });
    });
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Riwayat Transaksi");
    XLSX.writeFile(wb, "Riwayat_Transaksi.xlsx");
}
function exportStockExcel(){
    const rows = [];
    document.querySelectorAll("#stockBody tr").forEach(tr=>{
        const cells = tr.querySelectorAll("td");
        rows.push({
            Kode: cells[0].innerText,
            Nama: cells[1].innerText,
            Kategori: cells[2].innerText,
            Line: cells[3].innerText,
            "Sisa Stok": cells[4].innerText,
            Minimal: cells[5].innerText,
            Status: cells[6].innerText
        });
    });
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sisa Stock");
    XLSX.writeFile(wb, "Sisa_Stock.xlsx");
}

// ===== LOAD DATA =====
async function loadMasterFromSheets(){
    try{
        const res = await fetch(API_URL,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action:"getMasterData"})});
        const data = await res.json();
        if(Array.isArray(data)){
            masterDataGlobal = data.map(r=>({barcode:r.kode||r.barcode,nama:r.nama||"",satuan:r.satuan||"",minimal:Number(r.min||0),kategori:r.kategori||"",line:r.line||"",pic:r.pic||""}));
            tampilkanMaster(masterDataGlobal);
        }
    }catch(err){ console.warn("Gagal load master:",err);}
}
let transaksiGlobal = [];
async function loadTransaksiFromSheets(){
    try{
        const res = await fetch(API_URL,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action:"getTransaksi"})});
        const data = await res.json();
        if(Array.isArray(data)){
            transaksiGlobal = data;
            tampilkanRiwayat();
            updateStock();
        }
    }catch(err){ console.warn("Gagal load transaksi:",err);}
}

// ===== DISPLAY =====
function tampilkanRiwayat(){
    let tbody=document.getElementById("riwayatBody");
    tbody.innerHTML="";
    transaksiGlobal.forEach((t,i)=>{
        let bg = i%2===0 ? "#f5f5f5" : "#ffffff";
        tbody.innerHTML+=`<tr style="background:${bg}">
        <td>${t.waktu}</td><td>${t.kode}</td><td>${t.nama}</td><td>${t.kategori}</td><td>${t.line}</td><td>${t.pic}</td><td>${t.qty}</td><td>${t.jenis}</td>
        </tr>`;
    });
}

function updateStock(){
    let stockMap={};
    transaksiGlobal.forEach(t=>{
        if(!stockMap[t.kode]){
            let m=masterDataGlobal.find(x=>x.barcode==t.kode)||{};
            stockMap[t.kode]={kode:t.kode,nama:t.nama||m.nama||"",kategori:t.kategori||m.kategori||"",line:t.line||m.line||"",minimal:m.minimal||0,sisa:0};
        }
        if(t.jenis==="Masuk") stockMap[t.kode].sisa+=Number(t.qty);
        else stockMap[t.kode].sisa-=Number(t.qty);
    });
    masterDataGlobal.forEach(m=>{if(!stockMap[m.barcode]) stockMap[m.barcode]={kode:m.barcode,nama:m.nama,kategori:m.kategori||"",line:m.line||"",minimal:m.minimal||0,sisa:0};});
    let stockArray=Object.values(stockMap).sort((a,b)=>a.sisa-b.sisa);
    let tbody=document.getElementById("stockBody"); tbody.innerHTML="";
    stockArray.forEach((item,i)=>{
        let statusText="",cls="";
        if(item.sisa<=0){statusText="Habis"; cls="status-habis";}
        else if(item.sisa<item.minimal){statusText="Hampir Habis"; cls="status-hampir";}
        else{statusText="Aman"; cls="status-aman";}
        let bg = i%2===0 ? "#f5f5f5" : "#ffffff";
        tbody.innerHTML+=`<tr style="background:${bg}">
        <td>${item.kode}</td><td>${item.nama}</td><td>${item.kategori}</td><td>${item.line}</td><td>${item.sisa}</td><td>${item.minimal}</td><td class="${cls}">${statusText}</td>
        </tr>`;
    });
}

// ===== AUTO REFRESH =====
async function loadAllData(){ await loadMasterFromSheets(); await loadTransaksiFromSheets(); }
loadAllData();
setInterval(loadAllData,5000);
</script>

</body>
</html>

